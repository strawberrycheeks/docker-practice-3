# Список команд для оптимизации контейнеров и образов Docker

Изучив документацию Docker и различные статьи на данную тему, я составила список из 10 команд, которые могут помочь поддерживать Docker-окружение в чистоте и порядке. Эти команды предназначены для оптимизации использования пространства на диске, удаления ненужных контейнеров и образов, сетей и томов.

## Содержание

1. [Контейнеры](#containers)
1. [Образы](#images)
1. [Тома](#volumes)
1. [Сети](#networks)
1. [Логи](#logs)
1. [Кэш](#cache)

<h2 id="containers">Контейнеры</h2>

<a name="containers--container"></a><a name="1.1"></a>

- [1.1](#containers--container) **Удаление остановленных контейнеров**

```bash
docker container prune -f
```

Эту команду можно использовать, чтобы удалить контейнеры, которые завершили работу; запущенные контейнеры продолжат работу без изменений. Опция `-f` указывает, что команда должна быть выполнена без подтверждения. Если флаг `-f` опустить, то Docker запросит подтверждение, прежде чем удалить контейнеры.

Важно отметить, что команда не удалит связанные с контейнером образы, тома или сети. Для удаления этих объектов можно использовать другие команды из списка.

<a name="containers--container-filter"></a><a name="1.2"></a>

- [1.2](#containers--container-filter) **Удаление контейнеров с использованием фильтрации**

```bash
docker container prune --filter
```

В случае, если часть остановленных контейнеров нужно сохранить, можно применить команду с опцией `--filter`. Эта команда позволяет удалить остановленные контейнеры, которые соответствуют указанному фильтру. Запущенные контейнеры продолжат работать без изменений, даже если не соответствуют фильтру.

Например, в качестве фильтра можно использовать значение метки. Метку можно задать при создании контейнеров при помощи опции `--label`:

```bash
docker run -d --name container1 --label keep nginx
docker run -d --name container2 --label temp alpine
```

А затем проверять значение метки при удалении остановленных контейнеров. Например, можно удалить все контейнеры, у которых значение метки не равно "keep":

```bash
docker container prune --filter "label!=keep"
```

<a name="containers--stats"></a><a name="1.3"></a>

- [1.3](#containers--stats) **Просмотр статистики использования ресурсов для запущенных контейнеров**

```bash
docker stats
```

Эта команда применяется для просмотра статистики использования ресурсов для запущенных Docker-контейнеров в режиме реального времени. Отображаемые метрики включают: процент использования процессора, объем используемой памяти и установленный лимит памяти для контейнера, объем данных, переданных и полученных контейнером через сетевые интерфейсы, а также количество процессов, запущенных внутри контейнера. Данная информация может быть полезной для оптимизации использования ресурсов.

<h2 id="images">Образы</h2>

<a name="images--image"></a><a name="2.1"></a>

- [2.1](#images--image) **Удаление неиспользуемых образов**

```bash
docker image prune -a -f
```

Эта команда используется для очистки неиспользуемых образов, то есть образов, которые не связаны ни с одним контейнером, не имеют тегов и репозиториев. Если какой-то контейнер (даже остановленный) использует образ, то образ не будет удален. Для повторного использования удаленный образ нужно будет снова загрузить или собрать.

Опция `-f` указывает, что команда должна быть выполнена без подтверждения. Если флаг `-f` опустить, то Docker запросит подтверждение, прежде чем удалить образы.

<a name="images--image-filter"></a><a name="2.2"></a>

- [2.2](#images--image-filter) **Удаление неиспользуемых образов с использованием фильтрации**

```bash
docker image prune --filter
```

В случае, если часть неиспользуемых образов нужно сохранить, можно применить команду с опцией `--filter`. Эта команда позволяет удалить образы, которые соответствуют указанному фильтру. Например, можно удалить образы, которые не используются более 24 часов при помощи команды:

```bash
docker image prune --filter "until=24h"
```

<h2 id="volumes">Тома</h2>

<a name="volumes--volume"></a><a name="3.1"></a>

- [3.1](#volumes--volume) **Удаление неиспользуемых томов**

```bash
docker volume prune -f
```

Эту команду можно использовать, чтобы удалить все неиспользуемые тома Docker, то есть те тома, которые не подключены ни к одному контейнеру. Если тома используются контейнерами (даже остановленными), то они не будут удалены.

Важно отметить, что при удалении тома все данные в нем будут утеряны. Перед удалением стоит убедиться, что том действительно больше не нужен. Например, пере запуском можно посмотреть список неиспользуемых томов при помощи команды:

```bash
docker volume ls -f "dangling=true"
```

<h2 id="networks">Сети</h2>

<a name="networks--network"></a><a name="4.1"></a>

- [4.1](#networks--network) **Удаление неиспользуемых сетей**

```bash
docker network prune -f
```

Эта команда применяется, чтобы удалить все неиспользуемые сети Docker. Опция `-f` указывает, что команда должна быть выполнена без подтверждения.

<h2 id="logs">Логи</h2>

<a name="logs--limits"></a><a name="5.1"></a>

- [5.1](#logs--limits) **Ограничения на размер логов при запуске контейнера**

```bash
docker run --log-opt max-size=10m --log-opt max-file=3 my-container
```

В Docker нет специальной команды для удаления логов контейнеров, поэтому для оптимизации размера логов можно использовать эту команду при создании контейнера. В приведенном примере используются следующие опции:

- `max-size=10m` означает, что максимальный размер одного файла логов будет ограничен до 10МБ. Когда файл достигнет данного ограничения, Docker создаст новый файл.

- `max-file=3` означает, что Docker будет хранить не более 3 файлов логов. При достижении лимита старый файл будет удален, вместо него будет создан новый файл.

<a name="logs--clear"></a><a name="5.2"></a>

- [5.2](#logs--clear) **Ручное очищение логов контейнеров**

```bash
truncate -s 0 /var/lib/docker/containers/*/*-json.log
```

Эта команда может использоваться для того, чтобы вручную очистить файлы логов для всех контейнеров Docker. Важно отметить, что `truncate -s 0` обрезает размер файла логов до 0МБ, но не удаляет сам файл.

Если требуется очистить логи для конкретного контейнера, то нужно сначала узнать его container_id при помощи команды:

```bash
docker ps -a
```

Затем, используя полученный container_id, можно очистить файлы логов при помощи команды:

```bash
truncate -s 0 /var/lib/docker/containers/\<container_id\>/*-json.log
```

<h2 id="cache">Кэш</h2>

<a name="cache--builder"></a><a name="6.1"></a>

- [6.1](#cache--builder) **Удаление кэша сборки и неиспользуемых объектов**

```bash
docker builder prune -f
```

Эту команду можно использовать, чтобы очистить кэш сборки и удалить неиспользуемые данные, созданные при сборке образов. Например, такие данные могут включать в себя промежуточные слои образов, которые были созданы в процессе сборки, но больше не используются.
